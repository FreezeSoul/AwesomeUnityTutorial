# 宋朝历史与传说融合ARPG战斗系统设计文档

## 一、基础战斗机制

### 1.1 普通攻击连击

1. 轻攻击连击
   - 3段连击组合（动画时长：0.4s, 0.45s, 0.6s）
   - 每段攻击间隔0.5秒
   - 连击窗口1.2秒（可通过武学技能缩短至0.8秒）
   - 伤害倍率：100% → 110% → 130%
   - 最后一击有击退效果（距离2米，硬直0.3秒）
   - **技术实现**：AnimationEvent触发伤害判定，使用Collider2D检测命中

2. 重攻击系统
   - 蓄力时间1.2秒（可通过装备减少至0.8秒）
   - 伤害倍率200%（满蓄力250%）
   - 破防效果+50%（无视敌人50%防御）
   - 消耗内力值20点
   - 可打断敌人动作（打断优先级：高）
   - **蓄力机制**：按住攻击键蓄力，松开释放
   - **技术实现**：ChargeAttack组件，使用协程管理蓄力状态

3. 空中攻击
   - 跳跃攻击伤害120%
   - 空中连击最多3段（每段伤害递增10%）
   - 落地攻击范围伤害（3米半径，伤害衰减）
   - 空中攻击不消耗额外内力
   - **空中时间限制**：最多滞空2秒
   - **技术实现**：AerialCombat组件，检测地面距离和滞空时间

### 1.2 闪避格挡系统

1. 闪避机制
   - 闪避距离3米（可通过轻功提升至4.5米）
   - 无敌帧0.2秒（熟练度提升可达0.3秒）
   - 冷却时间1秒（连续闪避冷却递增：1s→1.5s→2s）
   - 消耗内力15点（轻装备-5点，重装备+5点）
   - 完美闪避触发慢动作（0.5秒，敌人攻击前0.1秒内闪避）
   - **方向性闪避**：8个方向，后撤距离+20%
   - **技术实现**：DodgeSystem组件，使用射线检测避免穿墙

2. 格挡系统
   - 格挡减伤70%（盾牌+10%，双手武器-10%）
   - 完美格挡减伤95%（并反弹10%伤害给攻击者）
   - 完美格挡窗口0.3秒（敌人攻击命中前0.3秒内格挡）
   - 格挡消耗内力10点（重攻击格挡消耗20点）
   - 连续格挡效果递减（第2次70%→60%，第3次60%→50%）
   - **格挡角度限制**：前方120度范围内有效
   - **技术实现**：BlockSystem组件，使用角度计算和时间窗口检测

3. 反击机制
   - 完美格挡后可反击（自动进入反击状态）
   - 反击伤害150%（武学熟练度影响：+0-50%）
   - 反击窗口1秒（技能可延长至1.5秒）
   - 反击必定暴击（暴击伤害200%）
   - 反击不消耗内力（但有独立冷却3秒）
   - **连锁反击**：反击成功后可触发第二次反击
   - **技术实现**：CounterAttack组件，状态机管理反击时机

### 1.3 硬直与霸体

1. 硬直系统
   - 受击硬直时间0.3秒（轻攻击）/0.6秒（重攻击）
   - 硬直累积机制：连续受击硬直时间叠加（最多1.5秒）
   - 硬直期间无法行动（但可消耗内力强制取消，消耗30点）
   - 连击可延长硬直时间（每次命中+0.1秒）
   - 部分武学可减少硬直（韧性武学-50%硬直时间）
   - **硬直恢复**：脱离战斗3秒后硬直抗性+50%
   - **技术实现**：StunSystem组件，使用计时器和状态标记

2. 霸体机制
   - 霸体状态免疫硬直和击退
   - 霸体持续时间有限（3-10秒，根据武学/装备）
   - 重攻击可破除霸体（需要连续3次重攻击）
   - 霸体有血量机制（100-500点霸体值）
   - 霸体破除后进入虚弱状态（防御-30%，持续5秒）
   - **霸体等级**：1-3级，高等级霸体需要更强攻击破除
   - **技术实现**：ArmorSystem组件，独立血量条和破除判定

3. 击飞击倒
   - 特定攻击可击飞敌人（重攻击、武学技能）
   - 击飞距离根据伤害计算（伤害/100 = 米数，最大5米）
   - 击倒状态持续2秒（可通过翻滚提前起身）
   - 击倒期间可追击（伤害+25%，但有追击次数限制）
   - 空中敌人受到额外伤害（+30%，重力影响伤害计算）
   - **环境交互**：击飞可造成撞墙额外伤害
   - **技术实现**：KnockbackSystem组件，物理引擎计算轨迹

### 1.4 受击反馈

1. 视觉反馈
   - 受击闪白效果（0.1秒，可在设置中关闭）
   - 血量条变化动画（平滑过渡，0.3秒完成）
   - 伤害数字飞出（颜色编码：白色普通，黄色暴击，红色致命）
   - 屏幕震动效果（强度0-100%可调，持续0.2秒）
   - 粒子特效展示（血液、火花、武学效果）
   - **慢动作效果**：致命一击触发0.3秒慢动作
   - **技术实现**：FeedbackManager组件，统一管理所有反馈效果

2. 音效反馈
   - 武器碰撞音效（金属、木质、武学不同音效）
   - 受击痛苦声音（根据伤害程度调整音调）
   - 暴击特殊音效（更响亮、更尖锐的音效）
   - 环境音效变化（战斗时背景音降低，突出战斗音效）
   - 背景音乐动态调整（战斗激烈度影响音乐节奏）
   - **3D音效**：根据攻击方向播放立体声音效
   - **技术实现**：AudioManager组件，使用音频池和3D音效

3. 手柄震动（支持Xbox和PlayStation手柄）
   - 攻击命中震动（轻攻击轻震，重攻击强震）
   - 受击震动反馈（根据伤害程度调整强度）
   - 震动强度可调节（0-100%，默认70%）
   - 不同攻击不同震动模式（单次、连续、渐强）
   - 特殊技能特殊震动（独特的震动节奏）
   - **震动模式**：轻击、重击、连击、武学各有专属模式
   - **技术实现**：VibrationManager组件，支持多种手柄协议

## 二、武学技能系统设计

### 2.1 武学技能类型划分

1. 主动武学（共60个武学，分3个等级）
   - 攻击武学（30个）
     * 单体伤害武学（伤害倍率150-400%，冷却3-8秒）
     * 范围伤害武学（3-8米范围，伤害衰减机制）
     * 持续伤害武学（DOT效果，3-10秒持续）
     * 控制武学（眩晕、减速、沉默，1-5秒持续）
     * **技术实现**：MartialArtsData ScriptableObject存储武学数据
   
   - 辅助武学（20个）
     * 增益BUFF武学（攻击+20-50%，持续10-30秒）
     * 治疗恢复武学（瞬间回复或持续回复）
     * 位移武学（轻功、瞬移，5-15米距离）
     * 防御武学（护盾、减伤，持续5-20秒）
     * **技术实现**：BuffSystem组件管理增益效果

2. 被动武学（40个被动武学）
   - 属性增强（基础被动）
     * 攻击力提升（+5-25%，分5级）
     * 防御力提升（+5-25%，分5级）
     * 生命值增加（+10-50%，分5级）
     * 内力值增加（+10-50%，分5级）
     * **技术实现**：PassiveMartialArtsManager计算属性加成
   
   - 特殊效果（高级被动）
     * 暴击率提升（+5-20%，分4级）
     * 攻击速度提升（+10-40%，分4级）
     * 移动速度提升（+10-30%，分3级）
     * 武学冷却缩减（+10-30%，分3级）
     * **技术实现**：StatModifier系统动态计算属性

3. 连携武学（特殊组合武学，16个组合）
   - 门派连携（武学相生相克）
     * 剑法+刀法：剑气刀光（范围5米，伤害300%）
     * 拳法+掌法：内劲外放（回复50%生命+解毒）
     * 枪法+掌法：枪掌合一（持续10秒，每秒50伤害）
     * 刀法+剑法：刀剑合璧（减速50%+破防）
     * **连携条件**：2秒内使用对应武学
     * **技术实现**：ComboMartialArtsDetector监测武学序列
   
   - 武器连携（武器类型组合）
     * 剑+法器：剑气远程（射程10米，穿透3个敌人）
     * 拳套+符咒：元素拳击（每拳附带随机元素）
     * 长枪+阵法：范围突刺（直线8米，宽度2米）
     * 弓箭+毒药：中毒箭矢（中毒持续8秒）
     * **连携条件**：装备对应武器+学会对应武学
     * **技术实现**：WeaponComboSystem检测装备组合

### 2.2 武学技能释放机制

1. 释放条件
   - 内力值消耗（基于武学等级和类型）
     * 低级武学：10-20点（1-15级武学）
     * 中级武学：25-40点（16-30级武学）
     * 高级武学：45-60点（31-45级武学）
     * 终极武学：70-100点（46-50级武学）
     * **内力回复**：每秒回复5点，脱战后每秒10点
     * **技术实现**：ResourceManager组件管理内力消耗和回复
   
   - 冷却时间（可通过装备和武学缩减）
     * 快速武学：3-5秒（基础攻击武学）
     * 常规武学：8-12秒（元素武学）
     * 强力武学：15-20秒（范围武学）
     * 终极武学：30-60秒（大招武学）
     * **全局冷却**：所有武学共享0.5秒全局冷却
     * **技术实现**：CooldownManager组件，使用计时器数组

2. 释放方式
   - 瞬发武学（40%的武学）
     * 按键即释放（响应时间<0.1秒）
     * 无施法时间
     * 可在移动中使用
     * 可被沉默打断
     * **技术实现**：InstantCast组件，立即执行武学效果
   
   - 引导武学（35%的武学）
     * 需要持续施法（进度条显示）
     * 施法时间1-3秒
     * 施法期间移动速度-70%
     * 被攻击会中断（需要承受伤害>当前生命10%）
     * **技术实现**：ChannelingCast组件，使用协程管理施法过程
   
   - 蓄力武学（25%的武学）
     * 按住蓄力增强效果（蓄力条显示）
     * 蓄力时间0.5-2秒
     * 可提前释放（最低30%效果）
     * 满蓄力效果最佳（200%基础效果）
     * **蓄力阶段**：30%→60%→100%→150%→200%
     * **技术实现**：ChargeCast组件，实时计算蓄力倍率

3. 武学衔接
   - 释放方式
     * 指向释放（鼠标指向目标）
     * 区域选择（范围武学预览）
     * 自身施法（以自己为中心）
     * 蓄力释放（按住蓄力）
   
   - 武学衔接
     * 普攻取消（武学可取消普攻后摇）
     * 武学连招（特定武学可无缝连接）
     * 武学联动（武学技能触发连携）
     * 武器切换（切换武器重置部分冷却）

4. 武学升级（每个武学最多5级）
   - 升级条件
     * 武学点消耗（1级1点，5级5点，总计15点/武学）
     * 使用次数要求（每级需要使用50次）
     * 前置武学要求（树状解锁结构）
     * 等级限制（每10级解锁新一层武学）
     * **武学熟练度**：使用次数影响武学效果微调
     * **技术实现**：MartialArtsProgression组件，记录使用数据
   
   - 升级效果（每级提升）
     * 伤害提升15%（1级100%→5级160%）
     * 冷却时间减少10%（最多减少40%）
     * 范围扩大10%（最多扩大40%）
     * 新增特殊效果（3级和5级解锁特殊效果）
     * **技术实现**：MartialArtsScaling组件，动态计算武学数值

3. 冷却与消耗设计
   - 冷却时间
     * A级武学：30秒
     * B级武学：20秒
     * C级武学：10秒
     * D级武学：5秒
   
   - 资源消耗
     * 内力值消耗
     * 元素能量消耗
     * HP消耗（特殊武学）
     * 道具消耗

4. 武学升级路线
   - 等级提升效果
     * 伤害提升
     * 冷却缩减
     * 效果强化
     * 范围扩大
   
   - 武学进阶
     * 效果变异
     * 附加特效
     * 机制改变
     * 元素转换

## 三、战斗节奏控制

1. 攻击节奏设计
   - 基础攻击节奏
     * 普攻间隔：0.5秒
     * 连击窗口：0.8秒
     * 武学前摇：0.2-0.5秒
     * 武学后摇：0.3-0.6秒
   
   - combo设计
     * 基础连击倍率：1.1x
     * 最大连击加成：2.0x
     * 连击保持时间：5秒
     * 段数衰减规则

2. 战斗流程控制
   - 开场阶段
     * 观察阶段（1-2秒）
     * 试探阶段（3-5秒）
     * 节奏建立（5-8秒）
   
   - 中期战斗
     * 武学交换
     * 资源管理
     * 走位周旋
     * 连击积累

   - 结束阶段
     * 爆发输出
     * 追击处理
     * 收尾武学
     * 战利品收集

3. 打断与反制机制
   - 打断系统
     * 硬直打断
     * 武学打断
     * 霸体击破
     * 架势崩坏
   
   - 反制设计
     * 反击窗口
     * 弹反机制
     * 招架反制
     * 破绽利用

## 四、敌人AI行为设计

1. AI决策模式
   - 基础行为树
     * 待机状态
     * 警戒状态
     * 战斗状态
     * 撤退状态
   
   - 战斗策略
     * 攻击距离判断
     * 招式选择权重
     * 配合行为判定
     * 特殊状态响应

2. 攻击模式设计
   - 基础攻击
     * 普通攻击组合
     * 范围武学释放
     * 追击判定
     * 防御反击
   
   - 特殊攻击
     * 蓄力大招
     * 连携武学
     * 陷阱布置
     * 召唤支援

3. 配合机制
   - 小怪配合
     * 包围战术
     * 远近结合
     * 元素配合
     * 武学联动
   
   - 精英怪特性
     * 指挥增益
     * 战术调度
     * 特殊能力
     * 小怪强化

4. 难度梯度
   - 普通怪物
     * 基础血量：500-1000
     * 攻击力：50-100
     * 防御力：30-60
     * AI复杂度：低
   
   - 精英怪物
     * 基础血量：2000-3000
     * 攻击力：150-200
     * 防御力：80-120
     * AI复杂度：中
   
   - BOSS设计
     * 基础血量：8000-10000
     * 攻击力：300-500
     * 防御力：150-200
     * AI复杂度：高

## 五、武器系统设计

1. 基础武器类型
   - 单手武器
     * 单手剑：灵活快速
     * 单手斧：破防强化
     * 单手锤：击晕效果
     * 短刀：暴击提升
   
   - 双手武器
     * 双手剑：范围伤害
     * 双手斧：高额伤害
     * 双手枪：突刺攻击
     * 长柄武器：距离优势

2. 武器特性设计
   - 基础属性
     * 伤害范围
     * 攻击速度
     * 暴击倍率
     * 元素亲和
   
   - 特殊效果
     * 武器技能
     * 被动加成
     * 元素附魔
     * 连击特效

3. 武器升级系统
   - 强化系统
     * 基础强化（+1到+10）
     * 进阶强化（+11到+15）
     * 完美强化（+16到+20）
     * 特殊强化效果
   
   - 改造系统
     * 属性词条添加
     * 特效改造
     * 外观定制
     * 套装改造

## 六、伤害计算系统

1. 基础伤害公式
```
最终伤害 = (基础伤害 + 附加伤害) * (1 + 增伤系数) * (1 - 减伤系数) * (1 + 暴击伤害) * 元素相性系数
```

2. 伤害系数详解
   - 基础伤害
     * 武器伤害
     * 武学倍率
     * 属性加成
     * 等级差异
   
   - 增伤系数
     * 武学增伤
     * buff加成
     * 特殊状态
     * 连击加成

3. 元素伤害系统
   - 相生相克
     * 相生：伤害1.2倍
     * 相克：伤害1.5倍
     * 同性：伤害0.8倍
     * 中性：伤害1.0倍
   
   - 元素叠加
     * 双重元素
     * 三重元素
     * 元素爆发
     * 特殊反应

4. 防御计算
   - 物理防御
     * 基础减伤
     * 护甲穿透
     * 固定减伤
     * 百分比减伤
   
   - 元素防御
     * 元素抗性
     * 抗性穿透
     * 元素减免
     * 特殊防御
